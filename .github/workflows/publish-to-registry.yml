name: Publish to ComfyUI Registry

# Manual publishing only - run via GitHub Actions UI
# This prevents accidental publishing of every version update
on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    name: Publish DazzleNodes Collection to Registry

    steps:
      - name: Check Out Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive  # Important: DazzleNodes uses git submodules

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Extract Version from version.py
        id: get_version
        run: |
          VERSION=$(python -c "import sys; sys.path.insert(0, '.'); from version import BASE_VERSION; print(BASE_VERSION)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Publish Custom Node
        uses: Comfy-Org/publish-node-action@main
        with:
          ## Add your own personal access token to your Github Repository secrets
          ## and reference it below. Please see the readme for more information.
          personal_access_token: ${{ secrets.REGISTRY_ACCESS_TOKEN }}
          version: ${{ steps.get_version.outputs.version }}

# Setup Instructions:
# 1. Create publisher account at https://registry.comfy.org/
# 2. Generate a personal access token from the registry
# 3. Add the token as a repository secret:
#    - Go to: Settings → Secrets and variables → Actions
#    - Click "New repository secret"
#    - Name: REGISTRY_ACCESS_TOKEN
#    - Value: Your token from the registry
# 4. Update PublisherId in pyproject.toml with your publisher ID

# To publish a new version:
# 1. Update MAJOR, MINOR, PATCH in version.py (git hooks will update __version__)
# 2. Commit and push to main branch
# 3. Create a git tag: git tag v0.1.0-alpha && git push origin v0.1.0-alpha
# 4. Go to: https://github.com/DazzleNodes/DazzleNodes/actions/workflows/publish-to-registry.yml
# 5. Click "Run workflow" → Select branch → Run workflow
# 6. This manual step prevents accidental publishing of every commit

# Note: DazzleNodes is a collection with git submodules
# The checkout action uses 'submodules: recursive' to include all nodes
# WARNING: fit-mask-to-image currently uses local path - will fail until published to GitHub
